---
phase: 02-core-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.ts
  - src/services/note-capture.ts
  - package.json
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude Agent SDK requires API key"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "https://console.anthropic.com/settings/keys -> Create key"

must_haves:
  truths:
    - "Config validates ANTHROPIC_API_KEY presence"
    - "Note capture service can extract title and tags from text"
    - "Note capture service writes markdown file with frontmatter to NOTES_DIR"
    - "Filename uses sanitized title with .md extension"
  artifacts:
    - path: "src/config.ts"
      provides: "ANTHROPIC_API_KEY validation"
      contains: "ANTHROPIC_API_KEY"
    - path: "src/services/note-capture.ts"
      provides: "captureNote function"
      exports: ["captureNote"]
      min_lines: 60
  key_links:
    - from: "src/services/note-capture.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "query() import"
      pattern: "import.*query.*claude-agent-sdk"
    - from: "src/services/note-capture.ts"
      to: "src/config.ts"
      via: "config.NOTES_DIR for cwd"
      pattern: "config\\.NOTES_DIR"
---

<objective>
Create the note capture service that analyzes text messages using Claude and writes markdown notes with AI-generated metadata.

Purpose: This is the core value proposition of Focus Bot - transforming casual messages into organized notes with intelligent titles and tags.

Output: Working note-capture.ts service that can be called by message handlers, plus config extended with ANTHROPIC_API_KEY.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-capture/02-RESEARCH.md

@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and extend config</name>
  <files>package.json, src/config.ts</files>
  <action>
1. Install required dependencies:
   ```bash
   npm install @anthropic-ai/claude-agent-sdk sanitize-filename
   ```

2. Extend src/config.ts to add ANTHROPIC_API_KEY validation:
   - Add new field to envSchema:
     ```typescript
     ANTHROPIC_API_KEY: z
       .string()
       .min(1, 'ANTHROPIC_API_KEY is required'),
     ```
   - Place it after NOTES_DIR in the schema

The config.ts already has the Zod pattern established. Follow the exact same style for consistency.
  </action>
  <verify>
- `npm ls @anthropic-ai/claude-agent-sdk` shows installed
- `npm ls sanitize-filename` shows installed
- TypeScript compiles: `npx tsc --noEmit`
- Starting bot without ANTHROPIC_API_KEY shows: "ANTHROPIC_API_KEY is required"
  </verify>
  <done>
Config validates ANTHROPIC_API_KEY and new dependencies are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create note capture service</name>
  <files>src/services/note-capture.ts</files>
  <action>
Create src/services/note-capture.ts following the patterns from 02-RESEARCH.md:

1. Define NoteMetadataSchema using Zod:
   ```typescript
   const NoteMetadataSchema = z.object({
     title: z.string().min(1).max(100)
       .describe('A concise, descriptive title for the note (1-100 chars)'),
     tags: z.array(z.string()).min(3).max(5)
       .describe('3-5 relevant tags as lowercase kebab-case')
   });
   ```

2. Implement extractMetadata(message: string) function:
   - Use query() from @anthropic-ai/claude-agent-sdk
   - Use structured output with z.toJSONSchema(NoteMetadataSchema)
   - Model: 'sonnet', maxTurns: 1
   - Prompt should ask Claude to analyze the message and generate title + tags
   - Parse result with NoteMetadataSchema.safeParse()
   - Throw descriptive error on failure

3. Implement generateNoteContent(metadata, originalMessage) function:
   - Return markdown string with YAML frontmatter
   - Frontmatter: title, created (ISO 8601), tags array
   - Body: original message exactly as provided

4. Implement generateFilename(title: string) function:
   - Use sanitize(title, { replacement: '-' }) from sanitize-filename
   - If sanitized is empty, fallback to `note-${Date.now()}`
   - Return filename + '.md'

5. Implement writeNoteFile(filename, content) function:
   - Use query() with cwd set to config.NOTES_DIR
   - Use disallowedTools to block everything except Write:
     ['Bash', 'Read', 'Edit', 'Glob', 'Grep', 'WebFetch', 'WebSearch', 'Task', 'NotebookEdit', 'TodoWrite', 'BashOutput', 'KillShell', 'SlashCommand']
   - permissionMode: 'acceptEdits', maxTurns: 3
   - Throw error on non-success result

6. Export captureNote(message: string) main function:
   - Calls extractMetadata to get title/tags
   - Generates filename and content
   - Calls writeNoteFile
   - Returns { title: string }

IMPORTANT: Use default export pattern for sanitize-filename:
```typescript
import sanitize from 'sanitize-filename';
```
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- File exists at src/services/note-capture.ts
- Exports captureNote function
- Imports query from @anthropic-ai/claude-agent-sdk
- Uses config.NOTES_DIR for cwd
  </verify>
  <done>
Note capture service exists with captureNote() that extracts metadata, generates markdown, and writes to vault.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npx tsc --noEmit` passes (no TypeScript errors)
2. `npm ls @anthropic-ai/claude-agent-sdk sanitize-filename` shows both installed
3. src/services/note-capture.ts exports captureNote
4. src/config.ts validates ANTHROPIC_API_KEY
</verification>

<success_criteria>
- Config extended with ANTHROPIC_API_KEY validation (fail-fast pattern)
- Dependencies installed (@anthropic-ai/claude-agent-sdk, sanitize-filename)
- Note capture service created with two-phase pattern (extract metadata, write file)
- Service follows all patterns from research (disallowedTools, structured output, sanitize-filename)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-capture/02-01-SUMMARY.md`
</output>
