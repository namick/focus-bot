---
phase: 02-core-capture
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/bot/handlers/message.ts
  - src/bot/bot.ts
autonomous: false

must_haves:
  truths:
    - "User can send any text message to the bot"
    - "Bot responds with 'Saved: [title]' confirmation"
    - "Text message becomes a markdown note in the vault"
  artifacts:
    - path: "src/bot/handlers/message.ts"
      provides: "Text message handler"
      exports: ["handleTextMessage"]
    - path: "src/bot/bot.ts"
      provides: "Bot with message handler registered"
      contains: "message:text"
  key_links:
    - from: "src/bot/handlers/message.ts"
      to: "src/services/note-capture.ts"
      via: "captureNote import and call"
      pattern: "captureNote\\("
    - from: "src/bot/bot.ts"
      to: "src/bot/handlers/message.ts"
      via: "handler registration"
      pattern: "bot\\.on.*message:text.*handleTextMessage"
---

<objective>
Wire the note capture service to the Telegram bot so users can send text messages that become notes.

Purpose: This completes the core capture flow - the entire value proposition of Focus Bot becomes usable.

Output: Working end-to-end flow where sending a text message to the bot creates a note in the vault.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-capture/02-RESEARCH.md
@.planning/phases/02-core-capture/02-01-SUMMARY.md

@src/bot/bot.ts
@src/bot/handlers/command.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create text message handler</name>
  <files>src/bot/handlers/message.ts</files>
  <action>
Create src/bot/handlers/message.ts following the patterns from 02-RESEARCH.md and existing command.ts:

```typescript
import { Context } from 'grammy';
import { captureNote } from '../../services/note-capture.js';

export async function handleTextMessage(ctx: Context): Promise<void> {
  const text = ctx.message?.text;
  if (!text) return;

  try {
    const result = await captureNote(text);
    await ctx.reply(`Saved: ${result.title}`);
  } catch (error) {
    console.error('Note capture failed:', error);
    await ctx.reply('Failed to save note. Please try again.');
  }
}
```

Key points:
- Follow existing handler pattern from command.ts (async, Context param, Promise<void>)
- Defensive check for text existence
- Try/catch wraps the async captureNote call
- Success: reply with "Saved: [title]"
- Failure: log error, reply with user-friendly message

Do NOT reply before captureNote completes - user should see confirmation only after note is saved.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- File exists at src/bot/handlers/message.ts
- Exports handleTextMessage function
- Imports captureNote from services
  </verify>
  <done>
Text message handler exists that calls captureNote and replies with confirmation or error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register message handler in bot</name>
  <files>src/bot/bot.ts</files>
  <action>
Update src/bot/bot.ts to register the text message handler:

1. Add import at top:
   ```typescript
   import { handleTextMessage } from './handlers/message.js';
   ```

2. Register handler AFTER commands but BEFORE error handler:
   ```typescript
   // Commands
   bot.command('start', handleStart);

   // Message handlers
   bot.on('message:text', handleTextMessage);

   // Error handler
   bot.catch((err) => { ... });
   ```

IMPORTANT: The handler must be registered AFTER auth middleware (which it already is, since auth is first) and AFTER commands. This ensures:
- /start doesn't trigger the text handler
- All messages pass through auth first
- Commands have priority over generic text handler

Grammy filter 'message:text' specifically matches text messages, not commands.
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- bot.ts imports handleTextMessage
- bot.ts contains `bot.on('message:text', handleTextMessage)`
  </verify>
  <done>
Bot has text message handler registered after commands and before error handler.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete note capture flow: text message -> Claude analysis -> markdown note in vault -> confirmation message</what-built>
  <how-to-verify>
1. Ensure .env has valid ANTHROPIC_API_KEY (in addition to existing config)
2. Start the bot: `npm run dev` (or `npx tsx src/index.ts`)
3. Open Telegram and send a text message to the bot (not a command)
   Example: "Had a great idea about improving the coffee machine algorithm using quantum entanglement"
4. Wait for response (may take 5-15 seconds for Claude processing)
5. Expected: Bot replies "Saved: [AI-generated title]"
6. Check NOTES_DIR for new .md file with:
   - Filename matching the title
   - YAML frontmatter with title, created timestamp, 3-5 tags
   - Original message as body

Failure modes to check:
- If "Failed to save note" appears, check console for error details
- If no response, bot may have crashed - check terminal
- If file doesn't exist, check cwd path in note-capture.ts
  </how-to-verify>
  <resume-signal>Type "approved" if note was created correctly, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes
2. Bot starts without errors
3. Sending text message creates note in vault
4. Note has correct frontmatter (title, created, tags)
5. Bot confirms with "Saved: [title]"
</verification>

<success_criteria>
Phase 2 success criteria from ROADMAP.md:
1. User can send any text message and it becomes a markdown note in the vault
2. Note has YAML frontmatter with generated title, created timestamp, and 3-5 relevant tags
3. Filename is the generated title with reserved characters sanitized plus .md extension
4. Bot confirms note was saved by displaying the generated title
5. Note content preserves original message exactly
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-capture/02-02-SUMMARY.md`
</output>
